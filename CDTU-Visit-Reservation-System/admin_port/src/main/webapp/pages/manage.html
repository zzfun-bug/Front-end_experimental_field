<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>admin审核</title>
    <!-- 本地引入 -->
    <link rel="stylesheet" href="/cdtu-visit/css/element-plus@2.4.4.css">
    <style>
        .app-container {
            position: relative;
            width: 100%;
            min-height: calc(100vh - 84px);
            padding: 10px;
        }
        
        /* 分页居中样式 */
        .el-pagination {
            text-align: center !important;
            display: flex !important;
            justify-content: center !important;
            align-items: center !important;
            width: 100% !important;
        }
        
        .el-pagination .el-pager {
            display: inline-flex !important;
        }
        
        /* 强制分页容器居中 */
        .el-pagination-wrapper {
            display: flex !important;
            justify-content: center !important;
            width: 100% !important;
        }
        
        /* 响应式设计 */
        @media (max-width: 1200px) {
            .app-container {
                padding: 5px;
            }
            
            .el-table {
                font-size: 12px;
            }
            
            .el-table .el-table__cell {
                padding: 8px 4px;
            }
        }
        
        @media (max-width: 768px) {
            .app-container {
                padding: 2px;
            }
            
            /* 移动端表格优化 */
            .el-table {
                font-size: 11px;
            }
            
            .el-table .el-table__cell {
                padding: 6px 2px;
            }
            
            /* 移动端按钮优化 */
            .el-button--small {
                padding: 4px 8px;
                font-size: 11px;
            }
            
            /* 移动端表单优化 */
            .el-form-item__label {
                font-size: 12px;
            }
            
            .el-input__inner {
                font-size: 12px;
            }
            
            /* 移动端对话框优化 */
            .el-dialog {
                width: 95% !important;
                margin: 0 auto;
            }
        }
        
        @media (max-width: 480px) {
            .app-container {
                padding: 1px;
            }
            
            /* 超小屏幕优化 */
            .el-table {
                font-size: 10px;
            }
            
            .el-table .el-table__cell {
                padding: 4px 1px;
            }
            
            .el-button--small {
                padding: 2px 4px;
                font-size: 10px;
            }
            
            /* 隐藏部分列在超小屏幕上 */
            .el-table .el-table__cell:nth-child(6),
            .el-table .el-table__cell:nth-child(7),
            .el-table .el-table__cell:nth-child(8) {
                display: none;
            }
        }
        
        /* 表格横向滚动 */
        .table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        /* 移动端分页优化 */
        @media (max-width: 768px) {
            .el-pagination {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .el-pagination .el-pager li {
                min-width: 28px;
                height: 28px;
                line-height: 28px;
                font-size: 12px;
            }
            
            .el-pagination .btn-prev,
            .el-pagination .btn-next {
                min-width: 28px;
                height: 28px;
                line-height: 28px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
<div id="app">
    <div class="app-container">
        <!--条件查询区域-->
        <el-form ref="queryFormRef" :model="queryParam" label-width="80px">
            <el-row :gutter="20">
                <el-col :xs="24" :sm="12" :md="8" :lg="6" :xl="6">
                    <el-form-item label="来访单位">
                        <el-input v-model="queryParam.visitUnit" size="small" placeholder="请输入部门名称"></el-input>
                    </el-form-item>
                </el-col>
                <el-col :xs="24" :sm="12" :md="8" :lg="6" :xl="6">
                    <el-form-item label="联系人">
                        <el-input v-model="queryParam.contactName" size="small" placeholder="请输入联系人名称"></el-input>
                    </el-form-item>
                </el-col>
                <el-col :xs="24" :sm="12" :md="8" :lg="6" :xl="6">
                    <el-form-item label="联系电话">
                        <el-input v-model="queryParam.contactPhone" size="small" placeholder="请输入联系电话"></el-input>
                    </el-form-item>
                </el-col>
                <el-col :xs="24" :sm="24" :md="24" :lg="6" :xl="6">
                    <el-form-item label-width="100px">
                        <el-button @click="handleSearch" type="primary" icon="Search" size="small">查询</el-button>
                        <el-button @click="handleReset" type="warning" icon="RefreshRight" size="small">重置</el-button>
                    </el-form-item>
                </el-col>
            </el-row>
        </el-form>
        <!--表格区域-->
        <el-row :gutter="20">
            <el-col :span="24">
                <div class="table-container">
                    <el-table :data="tableData" style="width: 100%; min-width: 800px;" border>
                    <el-table-column type="index" label="序号" width="60" align="center"></el-table-column>
                    <el-table-column label="参观时间" width="240" align="center">
                        <template #default="scope">
                            {{scope.row.visitDate}}
                        </template>
                    </el-table-column>
                    <el-table-column prop="visitUnit" label="单位名称" width="220" align="center"></el-table-column>
                    <el-table-column label="单位性质" width="120" align="center">
                        <template #default="scope">
                            <el-tag
                                    v-if="scope.row.visitNature === 1"
                                    type="primary"
                            >学校</el-tag>
                            <el-tag
                                    v-if="scope.row.visitNature === 2"
                                    type="success"
                            >企事业单位</el-tag>
                            <el-tag
                                    v-if="scope.row.visitNature === 3"
                                    type="warning"
                            >政府部门</el-tag>
                        </template>
                    </el-table-column>
                    <el-table-column label="来访人数" width="120" align="center">
                        <template #default="scope">
                            {{scope.row.visitNum}} / 人
                        </template>
                    </el-table-column>
                    <el-table-column prop="visitCar" label="车牌号" width="120" align="center"></el-table-column>
                    <el-table-column prop="contactName" label="联系人" width="120" align="center"></el-table-column>
                    <el-table-column prop="contactPhone" label="联系电话" width="160" align="center"></el-table-column>
                    <el-table-column prop="timeSolt" label="申请时间" width="320" align="center"></el-table-column>
                    <el-table-column label="审核状态" width="120" align="center">
                        <template #default="scope">
                            <el-tag v-if="scope.row.status === 0" type="info">待审核</el-tag>
                            <el-tag v-if="scope.row.status === 1" type="success">已通过</el-tag>
                            <el-tag v-if="scope.row.status === 2" type="danger">已驳回</el-tag>
                        </template>
                    </el-table-column>
                    <el-table-column label="操作" width="150" fixed="right" align="center">
                        <template #default="scope">
                            <el-button v-if="scope.row.status === 0" size="small" type="primary" icon="Edit"
                                       @click="handleEdit(scope.row)">审核</el-button>
                            <el-button v-else size="small" type="info" disabled>已审核</el-button>
                        </template>
                    </el-table-column>
                </el-table>
                </div>
            </el-col>
        </el-row>
        <!--分页条区域-->
        <el-row :gutter="20" style="margin-top: 20px">
            <el-col :span="24">
                <div class="el-pagination-wrapper">
                    <el-pagination
                            background
                            :page-size="queryParam.pageSize"
                            :current-page="queryParam.currentPage"
                            layout="prev, pager, next"
                            :total="total"
                            :hide-on-single-page="true"
                            @current-change="handlePageChange">
                    </el-pagination>
                </div>
            </el-col>
        </el-row>

        <!--编辑对话框-->
        <el-dialog title="申请审核" v-model="dialogUpdateVisible" width="36%">
            <el-form :model="updateForm" ref="updateFormRef" :rules="rules" label-width="100px" class="demo-ruleForm">
                <el-form-item label="参观时间:">
                    <el-input v-model="updateForm.visitDate" disabled style="width: 90%;"></el-input>
                </el-form-item>
                <el-form-item label="单位名称:">
                    <el-input v-model="updateForm.visitUnit" disabled style="width: 90%;"></el-input>
                </el-form-item>
                <el-form-item label="单位性质:">
                    <el-input v-model="visitNatureText" disabled style="width: 90%;"></el-input>
                </el-form-item>
                <el-form-item label="来访人数:">
                    <el-input v-model="updateForm.visitNum" disabled style="width: 90%;"></el-input>
                </el-form-item>
                <el-form-item label="车牌号:">
                    <el-input v-model="updateForm.visitCar" disabled style="width: 90%;"></el-input>
                </el-form-item>
                <el-form-item label="联系人:">
                    <el-input v-model="updateForm.contactName" disabled style="width: 90%;"></el-input>
                </el-form-item>
                <el-form-item label="联系电话:">
                    <el-input v-model="updateForm.contactPhone" disabled style="width: 90%;"></el-input>
                </el-form-item>
                <el-form-item label="审核状态:" prop="status">
                    <el-radio-group v-model="updateForm.status">
                        <el-radio :label="1">通过</el-radio>
                        <el-radio :label="2">驳回</el-radio>
                    </el-radio-group>
                </el-form-item>
                <template v-if="updateForm.status==1">
                    <el-form-item label="讲解员姓名:" prop="commentatorName">
                        <el-input v-model="updateForm.commentatorName" placeholder="请输入讲解员姓名" style="width: 90%;"></el-input>
                    </el-form-item>
                    <el-form-item label="讲解员电话:" prop="commentatorPhone">
                        <el-input v-model="updateForm.commentatorPhone" placeholder="请输入讲解员电话" style="width: 90%;"></el-input>
                    </el-form-item>
                </template>
                <el-form-item label="驳回说明:" prop="rejectReason" v-if="updateForm.status==2">
                    <el-input type="textarea" v-model="updateForm.rejectReason" placeholder="请输入驳回说明" style="width: 90%;"></el-input>
                </el-form-item>
            </el-form>
            <template #footer>
                    <el-button @click="dialogUpdateVisible = false">取 消</el-button>
                    <el-button type="primary" @click="handleUpdateSubmit">确 定</el-button>
                </template>
        </el-dialog>
    </div>
</div>
</body>
<script src="/cdtu-visit/js/vue@3.3.8.js"></script>
<script src="/cdtu-visit/js/element-plus@2.4.4.js"></script>
<script src="/cdtu-visit/js/axios.min.js"></script>
<script>
    const { createApp, ref, reactive, onMounted, computed } = Vue;
    const { ElMessage } = ElementPlus;

    createApp({
        setup() {
            const queryParam = reactive({
                visitUnit: '',
                contactName: '',
                contactPhone: '',
                currentPage: 1,
                pageSize: 4
            });

            const tableData = ref([]);
            const total = ref(0);

            const updateForm = reactive({
                id: null,
                visitDate: '',
                visitUnit: '',
                visitNature: '',
                visitNum: '',
                visitCar: '',
                contactName: '',
                contactPhone: '',
                status: 1,
                commentatorName: '',
                commentatorPhone: '',
                rejectReason: '',
            });

            const dialogUpdateVisible = ref(false);

            const rules = reactive({
                status: [{required: true, message: '请选择审核状态', trigger: 'change'}],
                commentatorName: [{ required: true, message: '请输入讲解员姓名', trigger: 'blur' }],
                commentatorPhone: [{ required: true, message: '请输入讲解员电话', trigger: 'blur' }],
                rejectReason: [{ required: true, message: '请输入驳回说明', trigger: 'blur' }],
            });

            const queryFormRef = ref(null);
            const updateFormRef = ref(null);

            const loadData = (currentPage = queryParam.currentPage, pageSize = queryParam.pageSize) => {
                axios({
                    url: "http://localhost:8080/cdtu-visit/page",
                    method: "get",
                    params: {
                        visitUnit: queryParam.visitUnit,
                        contactName: queryParam.contactName,
                        contactPhone: queryParam.contactPhone,
                        currentPage: currentPage,
                        pageSize: pageSize
                    }
                }).then(response => {
                    // response.data: 响应对象中的data属性存储就是，后端返回的数据
                    console.log('后端返回的完整数据:', response.data);
                    const data = response.data;
                    tableData.value = data.applyList || [];// 更新表格数据
                    total.value = data.total || 0; // 更新总记录数
                    console.log('当前页数据条数:', tableData.value.length);
                    console.log('总记录数:', total.value);
                }).catch(error => {
                    console.error('加载数据失败:', error);
                    ElMessage.error('加载数据失败');
                });
            };

            const handleSearch = () => {
                queryParam.currentPage = 1;
                loadData();
            };

            const handleReset = () => {
                Object.assign(queryParam, {
                    visitUnit: '',
                    contactName: '',
                    contactPhone: '',
                    currentPage: 1,
                    pageSize: 4
                });
                loadData();
            };

            const handlePageChange = (page) => {
                queryParam.currentPage = page;
                loadData();
            };

            const handleEdit = (row) => {
                Object.assign(updateForm, { ...row, status: row.status || 0 });
                dialogUpdateVisible.value = true;
            };

            // 单位性质转换函数
            const getVisitNatureText = (natureValue) => {
                switch(natureValue) {
                    case 1:
                        return '学校';
                    case 2:
                        return '企事业单位';
                    case 3:
                        return '政府部门';
                    default:
                        return '未知';
                }
            };

            // 计算属性：单位性质文字显示
            const visitNatureText = computed(() => {
                return getVisitNatureText(updateForm.visitNature);
            });

            const handleUpdateSubmit = () => {
                updateFormRef.value.validate(valid => {
                    if (valid) {
                        axios({
                            url: "http://localhost:8080/cdtu-visit/audit",
                            method: "post",
                            data: {
                                id: updateForm.id, // 更新记录的ID
                                visitDate: updateForm.visitDate, // 参观时间
                                visitUnit: updateForm.visitUnit, // 单位名称
                                visitNature: updateForm.visitNature, // 单位性质
                                visitNum: updateForm.visitNum, // 来访人数
                                visitCar: updateForm.visitCar, // 车牌号
                                contactName: updateForm.contactName, // 联系人
                                contactPhone: updateForm.contactPhone, // 联系电话
                                status: updateForm.status, // 审核状态
                                commentatorName: updateForm.commentatorName, // 讲解员姓名
                                commentatorPhone: updateForm.commentatorPhone, // 讲解员电话
                                rejectReason: updateForm.rejectReason, // 驳回理由
                                updateBy: "admin" // 当前更新操作的用户
                            }
                        }).then(response => {
                            console.log('响应数据:', response.data); // 打印响应数据用于调试
                            if (response.data.success) {
                                ElMessage.success('审核成功');
                                dialogUpdateVisible.value = false; // 关闭对话框
                                loadData(); // 重新加载数据，刷新表格
                            } else {
                                ElMessage.error(response.data.message || '审核失败');
                                console.log('提交数据:', updateForm);
                            }
                        }).catch(error => {
                            console.error('更新失败:', error);
                            ElMessage.error('更新失败');
                        });
                    } else {
                        ElMessage.warning('请填写完整信息');
                    }
                });
            };

            onMounted(() => {
                loadData(); // 初次加载数据
            });

            return {
                queryParam,
                tableData,
                total,
                updateForm,
                dialogUpdateVisible,
                rules,
                queryFormRef,
                updateFormRef,
                visitNatureText,
                loadData,
                handleSearch,
                handleReset,
                handlePageChange,
                handleEdit,
                handleUpdateSubmit
            };
        }
    }).use(ElementPlus).mount('#app');
</script>
</html>>


